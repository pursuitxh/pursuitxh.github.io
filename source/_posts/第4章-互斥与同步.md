---
title: 第4章-互斥与同步
date: 2019-01-11 15:43:54
tags: 读书笔记
categories:
- 读书笔记
- 深入Linux设备驱动程序内核机制
---
## 竟态/并发源/临界区的概念
1. 竟态： 简而言之，就是多个执行路径有可能对同一资源进行操作时可能导致的资源数据紊乱的行为；
2. 我们把对共享资源（大家都有可能同时执行的代码片段）称之为临界区；
3. 我们把导致出现多个执行路径的因素称之为并发源。

## 并发源的来源
1. 中断： 中断与被中断的进程之间可能会产生并发
2. 调度器的可抢占性： 可抢占会导致进程与进程之间产生并发
3. 多处理器：每个处理器上的进程之间可能导致并发

如果处理器A上使用spin_lock进入了临界区，而在处理器B上产生了中断，对应的中断处理函数同样使用spin_lock准备进入临界区，这时会发生什么情况？会死锁吗？

答：不会，处理器A上的进程可以继续执行，不会被处理器B上的中断打断，当处理器A的进程执行完之后，释放锁，处理器B上的中断就可以继续执行，所以要求spinlock保护的
的临界区代码必须在尽可能短的时间内执行完毕，因为它执行的时间越长，别的处理器就越需要自旋以等待更长的时间（尤其这种自旋发生在中断处理函数中）。

如果处理器A上使用spin_lock进入了临界区，而在处理器A上产生了中断，对应的中断处理函数同样使用spin_lock准备进入临界区，这时会发生什么情况？会死锁吗？

答： 会， 中断处理函数要获得的锁被中断的进程拿去了，而中断的进程又被中断打断，无法继续执行，从而无法释放锁，从而导致死锁。
针对这种情况，就需要使用spin_lock_irq, 进入临界区之前，先禁用本地中断。

## 对于单处理器系统来说，如何进行保护？

单处理器分为两类： 单处理器不可抢占系统和单处理器可抢占系统。
对于单处理器不可抢占系统来说，并发主要来源于外部中断等异步事件，所以在这种系统中，进入临界区时，只要关闭处理器的中断(local_irq_disable)，离开临界区时，只要恢复处理器中断(local_irq_enable)即可;
对于单处理器可抢占系统来说，并发来源除了中断与异常等异步事件外，还包括因为可抢占性导致的进程间的并发，所以在这种系统中，进入临界区时，除了要关闭处理器的中断，还需要关闭内核调度器的可抢占性。

## 对于多处理器系统来说, 如何进行保护？
使用spin_lock

## spin_lock是如何做到多处理器之间的互斥访问的？

spin_lock的核心思想是，设置一个在多处理器之间共享的全局变量V，各个处理器上需要首先检查V的状态，若不为0，则表明其他处理器正在对临界区进行访问，若为0，表明当前没有其他处理器上的代码进入临界区，可以
访问临界区，这时需要先把V置1（上锁），然后进入临界区，访问完毕后，离开临界区时，将V置0（解锁）。

核心在于确保处理器‘读取V，判断V，更新V’这一操作时原子操作的，如何保证原子操作的，主要借助于LDREX和STREX两条指令和local/global monitor（EX: exclusive）；

## 如何使用LDREX/STREX/local/global monitor做到多处理器对共享变量V的原子操作的？

见wowotech博客：Linux内核同步机制之（一）：原子操作
http://www.wowotech.net/linux_kenrel/atomic.html
https://blog.csdn.net/xiaoaid01/article/details/52092590

## spin_lock的变种
spin_lock_irq: 进程与中断之间，（进程中使用spin_lock_irq, 中断中使用spin_lock）
spin_lock_bh:  进程与延迟处理函数之间，（进程中使用spin_lock_bh,中断中使用spin_lock）