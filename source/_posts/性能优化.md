---
title: 性能优化
date: 2019-01-09 14:35:08
tags: 问题定位
categories: 
- 问题定位
- WIFI
---
## 问题背景
在PC硬件平台（CPU1.2GHz，4核，内存8G）上，开放环境UDP性能TX可以达到40Mbps+，RX可以达到30Mpbs+
   Host（PC，Tinkpad T430）---sdio---sdio WiFi模块
而当Host更换为嵌入式系统时(CPU单核，ARMV7架构，600Mbps，内存32M（剩余11M可用）)，UDP TX/RX性能只有16Mbps

## 问题定位
Host schedule时间慢于PC，导致fw无法将包聚合成AMPDU，从而导致性能急剧下降

## 问题解决
1. 利用Marvell sdio ip核独有的Aggr port技术，将数据包组合成一个大包，通过一个port一次性发送出去，性能提升一倍（16Mbps->30Mbps）；
   rx也是一样，host通过读取一个port，可以一次获得多个数据包，但是硬件rx aggr port有bug...， 后面通过fw软件聚合多个数据包，送到一个port上进行workaround

2. 之前发包逻辑为：iperf->xmit->enqueue->queue_work
   中断处理逻辑为： irq->read irq status->queue_work
   SDHCI使用的是中断线程化技术，将中断逻辑改为： irq->read irq status->直接call workqueue的处理函数， 即中断处理函数里不在schedule workqueue，省了一个次调度的时间，性能再次提升5Mbps

3. 之前workqueue的处理函数里，每次都会通过sdio cmd52命令去读取sdio rdbitmap/wrbitmp/rd len等寄存器，将其改为在中断处理函数中，通过cmd53命令一次性读取所有寄存器的值，在workqueue的处理函数
   中直接使用，性能再次提升5Mbps，最终开放环境中，UDP tx性能能够达到40Mbps。

